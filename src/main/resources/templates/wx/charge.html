<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>充值页面</title>
    <link rel="stylesheet" href="https://cdn.bootcss.com/weui/1.1.3/style/weui.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/jquery-weui/1.2.1/css/jquery-weui.min.css">
    <style type="text/css">
        body{
            background-color: #ededed;
        }
        .button-sp-area {
            margin: 15px auto;
            padding: 15px;
            text-align: center;
        }
        .itemBox{
            flex-flow: wrap;
        }
        .itemBox .weui-flex__item{
            width: 33.3%;
            box-sizing: border-box;
        }

        .itemBox .weui-flex__item div{
            text-align: center;
            padding: 20px;
            margin:5px;
            border-radius: 8px;
            background: white;
            border: 2px solid #ccc;
            color: gray;
            font-size: 15px;
        }
        .itemBox .weui-flex__item>div{
            text-align: center;
            padding: 20px;
            margin:5px;
            border-radius: 8px;
            background: white;
            border: 2px solid #ccc;
            color: gray;
            font-size: 15px;
        }
        .itemBox .active>div{
            background: #07c160;
            border: 2px solid #07c160;
            color: #fff;
        }
    </style>
</head>

<body>
<div class="page">
    <div class="page__bd">
        <div class="weui-cells weui-cells_form">
            <div class="weui-cell">
                <div class="weui-cell__bd">
                    <div class="weui-uploader">
                        <div class="weui-uploader__hd">
                            <p class="weui-uploader__title">充值金额</p>
                        </div>
                        <div class="weui-flex itemBox">
                            <div class="weui-flex__item"><div class="placeholder" data-toggle="100">100</div></div>
                            <div class="weui-flex__item"><div class="placeholder" data-toggle="200">200</div></div>
                            <div class="weui-flex__item"><div class="placeholder" data-toggle="500">500</div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="button-sp-area">
        <input type="hidden" value="0" name="money" id="money">
        <input type="hidden" th:value="${session['openId']}" name="openId" id="openId" >
        <a href="javascript:;" class="weui-btn weui-btn_block weui-btn_primary">充值</a>
    </div>
    <div class="page__bd page__bd_spacing" >
        <div class="weui-footer weui-footer_fixed-bottom" style="background-color: #ffffee;height: 20px;bottom: 0">
            <p class="weui-footer__text">启凡科技提供技术支持</p>
        </div>
    </div>
</div>
</body>
<script src="/js/zepto.min.js"></script>
<!-- body 最后 -->
<script src="https://cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/jquery-weui/1.2.1/js/jquery-weui.min.js"></script>
<script type="text/javascript">
    $(function () {

        function onBridgeReady(param) {
            WeixinJSBridge.invoke(
                'getBrandWCPayRequest', {
                    "appId": param['appId'],     //公众号名称，由商户传入
                    "timeStamp": param['timeStamp'],         //时间戳，自1970年以来的秒数
                    "nonceStr": param['nonceStr'], //随机串
                    "package": param['packageValue'],
                    "signType": param['signType'],         //微信签名方式:
                    "paySign": param['paySign']    //微信签名
                },
                function (res) {
                    // alert(res.err_msg);
                    // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。
                    if (res.err_msg == 'get_brand_wcpay_request:ok') {
                        $.toast("充值成功", function() {
                            location.href="/wx/member/chargeRecord";
                        });
                    }else if(res.err_msg == 'get_brand_wcpay_request:cancel'){
                        $.toast("取消支付", "cancel");
                    }else{
                        $.toast("支付失败", "forbidden");
                    }
                }
            );
        }

        $(".weui-flex__item").on("click",function(){
            if($(this).hasClass("active")){
                $(".weui-flex__item").removeClass("active");
                $("input[name='money']").val(0);
            }else {
                $(".weui-flex__item").removeClass("active");
                $(this).addClass("active");
                $("input[name='money']").val($(this).children().first().attr("data-toggle"));
            }
        });
        $(".weui-btn").on("click",function(){
            var openId = $("#openId").val();
            var money = $("#money").val();
            if(openId!="" && money>0){
                $.post('/wx/member/wxpay', {money:money,openId:openId}, function (ret) {
                    if (ret.code == 0){
                        console.log(ret.orderResult);
                        if (typeof WeixinJSBridge == "undefined"){
                            if( document.addEventListener ){
                                document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                            }else if (document.attachEvent){
                                document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                                document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                            }
                        }else{
                            var param = ret.result;
                            onBridgeReady(param);
                        }
                    }else{
                        alert(ret.msg);
                    }
                });
            }else {
                $.toast("请选择充值金额", "forbidden");
            }
        });
    });


</script>
</html>
