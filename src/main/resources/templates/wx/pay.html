<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
    <!-- 控制浏览器缓存 -->
    <meta http-equiv="Cache-Control" content="no-store">
    <!-- 优先使用 IE 最新版本和 Chrome -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <!-- 页面描述 -->
    <meta name="description" content="门店支付">
    <!-- 页面关键词 -->
    <meta name="keywords" content="">
    <title>门店支付</title>
    <link rel="stylesheet" href="https://cdn.bootcss.com/weui/1.1.3/style/weui.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/jquery-weui/1.2.1/css/jquery-weui.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        .clearfix:after {
            content: "\200B";
            display: block;
            height: 0;
            clear: both;
        }

        .clearfix {
            *zoom: 1;
        }


        /*IE/7/6*/

        .shuru div::-webkit-scrollbar {
            width: 0;
            height: 0;
            -webkit-transition: 1s;
        }

        .shuru div::-webkit-scrollbar-thumb {
            background-color: #a7afb4;
            background-clip: padding-box;
            min-height: 28px;
        }

        .shuru div::-webkit-scrollbar-thumb:hover {
            background-color: #525252;
            background-clip: padding-box;
            min-height: 28px;
        }

        .shuru div::-webkit-scrollbar-track-piece {
            background-color: #ccd0d2;
        }

        .wrap {
            position: relative;
            margin: auto;
            max-width: 640px;
            min-width: 320px;
            width: 100%;
            height: 100%;
            background: #F0EFF5;
            overflow: hidden;
        }

        .layer-content {
            position: absolute;
            left: 50%;
            bottom: -200px;
            width: 100%;
            max-width: 640px;
            height: auto;
            z-index: 12;
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
        }

        /* 输入表单 */

        .edit_cash {
            display: block;
            margin-top: 15px;
            padding: 15px;
            margin: 0 auto;
            width: 90%;
            border: 1px solid #CFCFCF;
            border-radius: 10px;
            background-color: #fff;
        }

        .edit_cash p {
            font-size: 14px;
            color: #8D8D8F;
        }

        .shuru {
            position: relative;
            margin-bottom: 10px;
        }

        .shuru div {
            border: none;
            width: 100%;
            height: 50px;
            font-size: 25px;
            line-height: 50px;
            border-bottom: 1px solid #CFCFCF;
            text-indent: 30px;
            outline: none;
            white-space: pre;
            overflow-x: scroll;
        }

        .shuru span {
            position: absolute;
            top: 5px;
            font-size: 25px;
        }

        .submit {
            display: block;
            margin: 30px auto 0;
            width: 90%;
            height: 40px;
            font-size: 16px;
            color: black;
            background: #80D983;
            border: 1px solid #47D14C;
            border-radius: 3px;
        }
        .active{
            color: white;
            background: #006400;
        }

        /* 键盘 */

        .form_edit {
            width: 100%;
            background: #D1D4DD;
        }

        .form_edit > div {
            margin-bottom: 2px;
            margin-right: 0.5%;
            float: left;
            width: 33%;
            height: 45px;
            text-align: center;
            color: #333;
            line-height: 45px;
            font-size: 18px;
            font-weight: 600;
            background-color: #fff;
            border-radius: 5px;
        }

        .form_edit > div:nth-child(3n) {
            margin-right: 0;
        }

        .form_edit > div:last-child {
            background-color: #DEE1E9;
        }

        .logo{
            margin: 0 auto;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-image: url("/images/logo.png") ;
            background-size: 100% 100%;
        }
    </style>
</head>
<body>
<div class="wrap">
    <div style="padding: 20px;text-align: center;height: 120px;">
        <div class="logo"></div>
        <span th:text="${store.name}"></span></div>
    <input type="hidden" th:value="${openId}" name="openId" id="openId" >
    <input type="hidden" th:value="${store.id}" name="openId" id="storeid" >
    <div style="margin-top: 20px;">
        <form action="" class="edit_cash">
            <p>消费总额</p>
            <div class="shuru">
                <span>¥</span>
                <div id="money"></div>
            </div>
            <p>可询问店员应支付金额</p>
        </form>
        <input type="submit" value="支付" class="submit">
    </div>
</div>
<div class="layer"></div>
<!--<div class="form">-->
<!--<form action="" method="post">-->
<!--<input type="text" placeholder="姓名">-->
<!--<input type="text" placeholder="联系电话">-->
<!--<input type="submit" value="提交" class="infor-sub">-->
<!--</form>-->
<!--</div>-->
<div class="layer-content">
    <div class="form_edit clearfix">
        <div class="num">1</div>
        <div class="num">2</div>
        <div class="num">3</div>
        <div class="num">4</div>
        <div class="num">5</div>
        <div class="num">6</div>
        <div class="num">7</div>
        <div class="num">8</div>
        <div class="num">9</div>
        <div class="num">.</div>
        <div class="num">0</div>
        <div id="remove">删除</div>
    </div>
</div>
<script src="https://cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/jquery-weui/1.2.1/js/jquery-weui.min.js"></script>
<script>
    $(function () {
        function onBridgeReady(param) {
            WeixinJSBridge.invoke(
                'getBrandWCPayRequest', {
                    "appId": param['appId'],     //公众号名称，由商户传入
                    "timeStamp": param['timeStamp'],         //时间戳，自1970年以来的秒数
                    "nonceStr": param['nonceStr'], //随机串
                    "package": param['packageValue'],
                    "signType": param['signType'],         //微信签名方式:
                    "paySign": param['paySign']    //微信签名
                },
                function (res) {
                    // alert(res.err_msg);
                    // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。
                    if (res.err_msg == 'get_brand_wcpay_request:ok') {
                        $.toast("支付成功", function() {
                            WeixinJSBridge.invoke('closeWindow',{},function(res){
                            });
                        });
                    }else if(res.err_msg == 'get_brand_wcpay_request:cancel'){
                        $.toast("取消支付", "cancel");
                    }else{
                        $.toast("支付失败", "forbidden");
                    }
                }
            );
        }


        $(".submit").bind("click",function(){
            var openId = $("#openId").val();
            var storeid = $("#storeid").val();
            var money = document.getElementById("money").innerHTML;
            var re =/^(([1-9][0-9]*)|(([0]\.\d{1,2}|[1-9][0-9]*\.\d{1,2})))$/;
            if(!re.test(money)){
                $.toast("支付金额有误", "forbidden");return false;
            }
            if(openId!=""&& storeid>0 && money>0){
                $.post('/wx/payment/storepay', {money:money,openId:openId,storeid:storeid}, function (ret) {
                    if (ret.code == 0){
                        if (typeof WeixinJSBridge == "undefined"){
                            if( document.addEventListener ){
                                document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                            }else if (document.attachEvent){
                                document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                                document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                            }
                        }else{
                            var param = ret.result;
                            onBridgeReady(param);
                        }
                    }else{
                        alert(ret.msg);
                    }
                });
            }else {
                $.toast("支付信息不正确", "forbidden");
            }
        });
        //填写信息
        $('.infor-sub').click(function (e) {
            $('.layer').hide();
            $('.form').hide();
            e.preventDefault();		//阻止表单提交
        });
        // 监听#div内容变化，改变支付按钮的颜色
        $('#money').bind('DOMNodeInserted', function () {
            if ($("#money").text() != "" || $("#money").text() > '0') {
                $('.submit').addClass('active');
                $('.submit').attr('disabled', false);
            } else {
                $('.submit').removeClass('active');
                $('.submit').attr('disabled', true);
            }
        });
        $('#money').trigger('DOMNodeInserted');

        $('.shuru').click(function (e) {
            $('.layer-content').animate({
                bottom: 0
            }, 200);
            e.stopPropagation();
        });
        $('.wrap').click(function () {
            $('.layer-content').animate({
                bottom: '-200px'
            }, 200)
        });

        $('.form_edit .num').click(function () {
            var oDiv = document.getElementById("money");
            if(this.innerHTML=="."){
                if(oDiv.innerHTML==""){
                    oDiv.innerHTML="0.";
                }else if(oDiv.innerHTML.indexOf(".")<0) {
                    oDiv.innerHTML += this.innerHTML;
                }
            }else {
                if(oDiv.innerHTML.indexOf(".")>0){
                    var numbers=oDiv.innerHTML.split(".");
                    var digits=numbers[1];
                    if(digits.length>=2){
                        digits=digits.substr(0,2);
                        oDiv.innerHTML=numbers[0]+"."+digits;
                    }else {
                        oDiv.innerHTML += this.innerHTML;
                    }

                }else {
                    oDiv.innerHTML += this.innerHTML;
                }
            }
        });
        $('#remove').click(function () {
            var oDiv = document.getElementById("money");
            var oDivHtml = oDiv.innerHTML;
            oDiv.innerHTML = oDivHtml.substring(0, oDivHtml.length - 1);
        })
    })
</script>


</body>
</html>