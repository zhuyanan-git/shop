<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
    <meta charset="utf-8">
    <head>
        <link href="layui/css/layui.css" rel="stylesheet">
        <link href="css/bootstrap.min14ed.css?v=3.3.6" rel="stylesheet">
        <link href="css/font-awesome.min93e3.css?v=4.4.0" rel="stylesheet">
        <link href="css/animate.min.css" rel="stylesheet">
        <link href="css/style.min862f.css?v=4.1.0" rel="stylesheet">
    </head>
    <body class="gray-bg">
        <div class="container-div">
            <div class="layui-form">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">开始日</label>
                        <div class="layui-input-block">
                            <input type="text" name="startTime" id="startTime" placeholder="请输入开始时间" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">结束日</label>
                        <div class="layui-input-inline">
                            <input type="text"name="endTime" id="endTime" autocomplete="off" placeholder="请输入结束时间" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">订单号</label>
                        <div class="layui-input-inline">
                            <input type="text" name="orderno" id="orderno"  autocomplete="off" placeholder="请输入订单号" class="layui-input">
                        </div>
                        <button class="layui-btn layuiadmin-btn-list" onclick="search()">
                            <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>
                        </button>
                    </div>
                </div>
            </div>

            <script type="text/html" id="statusTpl">
                {{#  if(d.status == 0){ }}
                <span>未支付</span>
                {{#  } }}
                {{#  if(d.status==1){ }}
                <span>支付成功</span>
                {{#  } }}
                {{#  if(d.status == 2){ }}
                <span> 支付失败</span>
                {{#  } }}
                {{#  if(d.status == 3){ }}
                <span> 已退款</span>
                {{#  } }}
            </script>

            <!--表格行元素的对象增删改查-->
            <script type="text/html" id="barscan">
                <a class="layui-btn layui-btn-sm" lay-event="refund">退款</a>
            </script>

            <div class="row">
                <table id="scan" class="layui-table"  lay-filter="scan"></table>
            </div>
        </div>

        <script src="/js/jquery.min.js?v=2.1.4"></script>
        <script src="/js/plugins/metisMenu/jquery.metisMenu.js"></script>
        <script src="/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
        <script src="/js/plugins/layer/layer.min.js"></script>
        <script src="/js/hplus.min.js?v=4.1.0"></script>
        <script type="text/javascript" src="/js/contabs.min.js"></script>
        <script src="/js/plugins/pace/pace.min.js"></script>
        <script src="/layui/layui.js"></script>

        <script >

            $(function(){
              scanManage()
            });

            function scanManage(){
                layui.use(['table','layer','laydate'], function(){
                    var laydate = layui.laydate;
                    var $ = layui.jquery;
                    var table = layui.table;
                    var layer = layui.layer;

                    //日期时间选择器
                    laydate.render({
                        elem: '#startTime'
                        ,type: 'datetime'
                    });

                    //日期时间选择器
                    laydate.render({
                        elem: '#endTime'
                        ,type: 'datetime'
                    });
                       table.render({
                            elem: '#scan',
                            toolbar: '#toolbarScan',
                            url: '/scan/list/', //数据接口
                            page: true,//开启分页
                            cols: [
                                [ //表头
                                    {field: 'id', title: '订单编号', }
                                    , {field: 'storename', title: '门店名称'}
                                    //, {field: 'openid', title: 'openid', width: 200}
                                    , {field: 'orderno', title: '订单号'}
                                     , {field: 'price',title: '支付金额'}
                                    , {field: 'status',title: '状态', templet: '#statusTpl'}
                                    , {field: 'submittime',title: '订单提交时间'}
                                    , {field: 'outrefundno',title: '退款单号'}
                                    , {field: 'refundtime',title: '退款时间'}
                                    , {field: 'refunduser',title: '退款人'}
                                    , {field: 'action', title: '操作',width: 200,toolbar: '#barscan'}
                                ]
                            ],
                        });

                    table.on('tool(scan)', function(obj){ //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
                        var data = obj.data; //获得当前行数据
                        var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
                        var tr = obj.tr; //获得当前行 tr 的DOM对象
                        if(layEvent === 'refund'){ //删除
                            layer.confirm('您确定该订单要退款吗？', function(index){
                                var id= data.id;
                                $.post("/scan/refund",{id:id},function (result) {
                                    if (result.success){
                                        layer.alert("退款成功",function () {
                                            window.location.reload();
                                        });
                                    } else{
                                        layer.alert(result.errorInfo);
                                    }
                                })
                            });
                        } else if(layEvent === 'delete'){ //删除
                            layer.confirm('您确定删除这条数据吗？', function(index){
                                var id= data.id;
                                $.post("/scan/delete",{id:id},function (result) {
                                    if (result.success){
                                        layer.alert("提交成功",function () {
                                            window.location.reload();
                                        });
                                    } else{
                                        layer.alert("删除失败");
                                    }
                                })
                            });
                        }
                    });
                    });





            }

            function search(){

                var startTime=$("#startTime").val();
                var endTime=$("#endTime").val();
                var orderno=$("#orderno").val();
                layui.use('table', function(){
                    var table = layui.table;
                    //这里以搜索为例
                    table.reload('scan',{
                        where: { //设定异步数据接口的额外参数，任意设
                            startTime: startTime,
                            endTime: endTime,
                            orderno:orderno
                        }
                        ,page: {
                            curr: 1 //重新从第 1 页开始
                        }
                    });
                });
            }
            //弹出添加菜单页面
            function add() {
                //iframe层
                layer.open({
                    type: 2,
                    title: '添加菜单页面',
                    shadeClose: true,
                    shade: 0.2,
                    area: ['500px', '90%'],
                    content: '/scan/add',
                    end: function () {
                        scanManage();
                    }
                });
             }
            function generate(){
                $.getJSON("/scan/generate",function (result) {
                    if (result.success==0){
                        layer.alert("生成菜单成功",function () {
                            window.location.reload();
                        });
                    } else{
                        layer.alert("生成菜单失败");
                    }
                })
            }
        </script>
    </body>
</html>